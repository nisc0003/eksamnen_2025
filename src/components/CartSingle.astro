---
// pages/checkout.astro
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <main class="checkout_page">
    <h1>Checkout</h1>

    <div class="checkout_content">
      <!-- Venstre side - Kurvoversigt -->
      <section class="cart_summary">
        <h2>Din ordre</h2>

        <!-- Genbrug samme struktur som i cart_container -->
        <button class="delete-all cta1">Slet alt</button>

        <section class="cart_sub">
          <div class="cart_list" id="checkout_cart_list"></div>
        </section>

        <!-- Prisoversigt - samme struktur som original -->
        <section class="price_amount">
          <div class="price_original">
            <p>Subtotal</p>
            <p id="checkout_subtotal">0.00 DKK</p>
          </div>
          <hr />
          <div class="price_discounted">
            <p>Rabat</p>
            <div class="discount"><p id="checkout_discount">0.00 DKK</p></div>
          </div>
          <hr />
        </section>

        <!-- Total pris - samme struktur -->
        <section class="total_price">
          <h3>Pris i alt</h3>
          <div class="price_value">
            <h3 id="checkout_total">0.00 DKK</h3>
          </div>
        </section>
      </section>

      <!-- Højre side - Betalingsformular -->
      <section class="payment_section">
        <h2>Betalingsoplysninger</h2>
        <form id="payment_form">
          <!-- Formularfelter -->
          <div class="form_group">
            <label for="name">Fulde navn</label>
            <input type="text" id="name" required class="form_input" />
          </div>

          <div class="form_group">
            <label for="email">Email</label>
            <input type="email" id="email" required class="form_input" />
          </div>

          <div class="form_group">
            <label for="address">Adresse</label>
            <input type="text" id="address" required class="form_input" />
          </div>

          <div class="form_row">
            <div class="form_group">
              <label for="zip">Postnummer</label>
              <input type="text" id="zip" required class="form_input" />
            </div>

            <div class="form_group">
              <label for="city">By</label>
              <input type="text" id="city" required class="form_input" />
            </div>
          </div>

          <div class="form_group">
            <label for="phone">Telefon</label>
            <input type="tel" id="phone" required class="form_input" />
          </div>

          <h3>Betalingsmetode</h3>
          <div class="payment_methods">
            <label class="payment_method">
              <input type="radio" name="payment" value="card" checked />
              <span>Kreditkort</span>
            </label>

            <label class="payment_method">
              <input type="radio" name="payment" value="mobilepay" />
              <span>MobilePay</span>
            </label>
          </div>

          <!-- Kortindtastningsområde -->
          <div id="card_element" class="card_element"></div>

          <!-- Bekræftelsesknap - bruger samme styling som cta_buy -->
          <button type="submit" class="cta_buy submit_order"
            >Bekræft ordre</button
          >
        </form>
      </section>
    </div>
  </main>
</Layout>

<script is:inline>
  // Genbrug samme logik som i cart_container
  document.addEventListener("DOMContentLoaded", () => {
    // Hent kurvdata fra localStorage
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    const cartList = document.getElementById("checkout_cart_list");

    // Opdater kurvvisning - næsten identisk med original
    function updateCheckoutDisplay() {
      cartList.innerHTML = "";

      if (cart.length === 0) {
        cartList.innerHTML = `
          <div class="empty_cart">
            <p>Din kurv er tom</p>
            <a href="/">
              <button class="cta_basket">Fortshop</button>
            </a>
          </div>
        `;
        return;
      }

      let subtotal = 0;
      let discountTotal = 0;

      // Loop igennem varer - samme struktur som original
      cart.forEach((item, index) => {
        const { img, title, title2, price, Old_price, quantity = 1 } = item;
        const currentPrice = parseFloat(price);
        const oldPrice = Old_price ? parseFloat(Old_price) : null;
        const discount = oldPrice ? (oldPrice - currentPrice) * quantity : 0;

        subtotal += currentPrice * quantity;
        discountTotal += discount;

        // Genbrug samme produkt HTML-struktur
        const product = document.createElement("div");
        product.className = "product";
        product.innerHTML = `
          <div class="product_image">
            <img src="/beer-card_images/${img}" alt="${title}" />
          </div>
          <div class="product_info">
            <h5 class="product_title">${title}</h5>
            ${title2 ? `<h6 class="product_subtitle">${title2}</h6>` : ""}
            <div>
              <div class="amount_grid">
                <p class="p_quantity">${quantity} stk.</p>
                <div class="amount_grid">
                  <button class="quantity-up" data-index="${index}">▲</button>
                  <button class="quantity-down" data-index="${index}">▼</button>
                </div>
              </div>
              ${
                Old_price
                  ? `<div class="old_price_row">
                      <h6 class="h6_Old_price">${Old_price} kr.</h6>
                     </div>`
                  : ""
              }
              <div class="total_row">
                <h6 class="h6_price">${(currentPrice * quantity).toFixed(2)} DKK.</h6>
              </div>
              <button class="delete-item" data-index="${index}">Slet</button>
            </div>
          </div>
        `;

        cartList.appendChild(product);
      });

      // Opdater totaler - samme logik som original
      document.getElementById("checkout_subtotal").textContent =
        subtotal.toFixed(2) + " DKK.";
      document.getElementById("checkout_discount").textContent =
        discountTotal.toFixed(2) + " DKK.";
      document.getElementById("checkout_total").textContent =
        (subtotal - discountTotal).toFixed(2) + " DKK.";
    }

    // Initial opdatering
    updateCheckoutDisplay();

    // Håndter kurvoperationer - samme logik som original
    document.addEventListener("click", (event) => {
      if (event.target.classList.contains("delete-all")) {
        cart = [];
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCheckoutDisplay();
      }

      if (event.target.classList.contains("delete-item")) {
        const index = parseInt(event.target.getAttribute("data-index"));
        if (!isNaN(index)) {
          cart.splice(index, 1);
          localStorage.setItem("cart", JSON.stringify(cart));
          updateCheckoutDisplay();
        }
      }

      if (event.target.classList.contains("quantity-up")) {
        const index = parseInt(event.target.getAttribute("data-index"));
        if (!isNaN(index)) {
          cart[index].quantity += 1;
          localStorage.setItem("cart", JSON.stringify(cart));
          updateCheckoutDisplay();
        }
      }

      if (event.target.classList.contains("quantity-down")) {
        const index = parseInt(event.target.getAttribute("data-index"));
        if (!isNaN(index) && cart[index].quantity > 1) {
          cart[index].quantity -= 1;
          localStorage.setItem("cart", JSON.stringify(cart));
          updateCheckoutDisplay();
        }
      }
    });

    // Håndter betalingsformular
    const paymentForm = document.getElementById("payment_form");
    paymentForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const submitBtn = paymentForm.querySelector(".submit_order");
      submitBtn.disabled = true;
      submitBtn.textContent = "Behandler...";

      // Simuler betalingsbehandling
      setTimeout(() => {
        // Gem ordrehistorik
        const orders = JSON.parse(localStorage.getItem("orders")) || [];
        orders.push({
          date: new Date().toISOString(),
          items: cart,
          total: document.getElementById("checkout_total").textContent,
          customer: {
            name: document.getElementById("name").value,
            email: document.getElementById("email").value,
          },
        });
        localStorage.setItem("orders", JSON.stringify(orders));

        // Tøm kurven
        localStorage.removeItem("cart");

        // Omdiriger til tak-siden
        window.location.href = "/tak-for-din-ordre";
      }, 1500);
    });
  });
</script>

<style>
  /* Genbrug samme grundlæggende styling */
  .checkout_page {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1rem;
  }

  h1 {
    text-align: center;
    margin-bottom: 2rem;
    font-family: "Montserrat", sans-serif;
    color: var(--second-color);
    font-size: 2rem;
  }

  .checkout_content {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
  }

  @media (min-width: 992px) {
    .checkout_content {
      grid-template-columns: 1fr 1fr;
    }
  }

  /* Genbrug styling fra cart_container */
  .cart_summary {
    background: var(--font-color-white);
    padding: 2rem;
    border-radius: 8px;
  }

  .payment_section {
    background: var(--font-color-white);
    padding: 2rem;
    border-radius: 8px;
  }

  /* Formular styling - tilpasset men konsistent med eksisterende */
  .form_group {
    margin-bottom: 1.5rem;
  }

  .form_row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  label {
    display: block;
    margin-bottom: 0.5rem;
    font-family: "Inter", sans-serif;
    color: var(--second-color);
  }

  .form_input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 3px;
    font-family: "Inter", sans-serif;
  }

  /* Betalingsmetoder */
  .payment_methods {
    display: flex;
    gap: 1.5rem;
    margin: 1rem 0;
  }

  .payment_method {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: "Inter", sans-serif;
  }

  /* Kortindtastningsområde */
  .card_element {
    padding: 1rem;
    border: 1px solid #ddd;
    border-radius: 3px;
    margin: 1rem 0;
  }

  /* Tilføj resten af de originale styles her */
  /* ... */

  /* Behold alle de originale :global regler */
  :global(.product) {
    display: grid;
    grid-template-columns: 1fr 2fr;
    align-items: start;
  }

  :global(.amount_grid) {
    display: grid;
    grid-template-columns: auto auto;
    grid-row: 1fr;
    gap: 0.75rem;
    width: min-content;
    place-content: left;
    margin-bottom: 1rem;
  }

  :global(.product_title) {
    text-transform: uppercase;
    font-weight: 700;
  }

  :global(.h6_price) {
    font-style: oblique;
    font-size: 1rem;
    font-weight: 600;
  }

  /* ... og alle de andre originale :global regler ... */
</style>
